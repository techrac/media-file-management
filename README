# Media File Management Tool

A Python tool for organizing and managing media files (photos and videos) by extracting metadata and performing various organizational tasks.

## Features

The tool operates in **two distinct modes**:

### Local Mode (Direct File Operations)
- **Rename Media Files**: Automatically rename photos and videos using timestamps extracted from EXIF metadata
- **Find and Delete Duplicates**: Identify duplicate files using SHA256 checksums and remove them
- **Flatten Directory Structure**: Move all files from subdirectories to the root folder
- **Timezone Support**: Handle timezone conversion for files with GPS coordinates or specify a default timezone
- **Dry Run Mode**: Preview changes before actually modifying files
- **Debug Mode**: Verbose output for troubleshooting

### Remote SSH Mode (Script Generation)
- **Connect via SSH to QNAP**: Uses key-based authentication to connect to QNAP devices
- **Scan for Cleanup Issues**: Remotely scans for:
  - Permission problems (wrong ownership, executable image files)
  - Empty folders (excluding configurable patterns like `.fcpbundle`)
  - Legacy files (Windows cache files: `Thumbs.db`, `ehthumbs.db`, `Desktop.ini`, `IconCache.db`)
  - Legacy directories (`.@__thumb`, `.streams` folder at root)
  - macOS resource fork files (`._*` files with matching non-prefixed files)
  - Problematic filenames (characters like `:`, `~` that cause replication issues)
- **Generate Categorized Scripts**: Creates organized bash scripts ready for QNAP SSH terminal (run in order):
  - `permissions_to_fix.sh` - Permission fix commands
  - `files_to_rename.sh` - Filename sanitization commands (run early to ensure clean names for all operations)
  - `files_to_delete.sh` - Legacy file deletion commands
  - `folders_to_delete.sh` - Empty folder cleanup (run after renaming to avoid issues with invalid chars)
- **Script Review**: Never executes changes directly - only generates scripts for user review and manual execution

### Interface
- **Both CLI and GUI**: Available as both command-line tool and graphical user interface

## How It Works

The tool reads EXIF metadata from media files to extract creation timestamps. It prioritizes different metadata sources in this order:
1. EXIF creation date (local time)
2. QuickTime creation date with timezone info
3. QuickTime creation date converted from UTC using GPS coordinates
4. QuickTime creation date converted from UTC using specified timezone
5. QuickTime creation date (assumed local time)

Files are renamed using the format: `YYYYMMDD_HHMMSS-original_name.extension`

## Usage

### Command Line Interface

#### Local Mode

```bash
# Basic usage - rename files with dry run
python main.py /path/to/photos --rename --dry-run

# Full workflow with all features
python main.py /path/to/photos --flatten --delete-dups --rename --timezone "Europe/Paris"

# Available local mode options:
# --rename        Rename media files using metadata timestamps
# --delete-dups   Find and delete duplicate files
# --flatten       Move all files to root directory
# --dry-run       Preview changes without modifying files
# --debug         Verbose output
# --timezone      Specify timezone for UTC conversion
# --force-overwrite  Force overwrite existing timestamp prefixes
```

#### Remote SSH Mode

```bash
# Generate cleanup scripts for QNAP
python main.py --remote-mode \
  --ssh-host qnap.local \
  --ssh-user admin \
  --ssh-key ~/.ssh/qnap_key \
  --share-path /share/Jinhwa/ \
  --share-owner jinhwa \
  --cleanup-all

# Or select specific cleanup operations:
python main.py --remote-mode \
  --ssh-host qnap.local \
  --ssh-user admin \
  --ssh-key ~/.ssh/qnap_key \
  --share-path /share/Jinhwa/ \
  --share-owner jinhwa \
  --cleanup-permissions \
  --cleanup-empty-folders \
  --cleanup-legacy-files \
  --cleanup-filenames

# Available remote mode options:
# --remote-mode, --ssh-mode     Enable remote SSH mode
# --ssh-host                     QNAP hostname or IP address
# --ssh-user                     SSH username
# --ssh-key                      Path to SSH private key file (required)
# --ssh-port                     SSH port (default: 22)
# --share-path                   Path to share root on QNAP
# --share-owner                  Username of share owner
# --cleanup-all                  Enable all cleanup scans
# --cleanup-permissions          Scan for permission issues
# --cleanup-empty-folders        Scan for empty folders
# --cleanup-legacy-files         Scan for legacy files
# --cleanup-filenames            Scan for problematic filenames
# --problem-chars                Problematic characters (default: ": ~")
# --char-replacements            Replacement characters (default: "- _")
# --exclude-folder               Folders to exclude (default: ".fcpbundle")
# --output-dir                   Output directory for scripts
```

### Graphical User Interface

```bash
python gui.py
```

The GUI provides a user-friendly interface with:

**Local Mode:**
- Folder browser
- Checkboxes for each action (rename, delete-dups, flatten)
- Timezone selector
- Command preview
- Real-time output console
- Settings persistence

**Remote SSH Mode:**
- SSH connection settings (host, user, key file, port)
- Share path and owner configuration
- Cleanup operation checkboxes
- Problematic character configuration
- Output directory selection
- Script generation with categorized output
- Settings persistence

## Development

```bash
# activate the virtual env (if using one)
source ./.venv/bin/activate

# run command line version (debug from IDE)
python main.py

# run GUI version (debug from IDE)
python gui.py

# package the Mac app (with cx_freeze)
python setup.py bdist_mac
```

The build process will:
1. Create the `MediaTool.app` bundle in `build/`
2. Automatically create a timestamped distribution zip (e.g., `MediaTool_20251002_152502.zip`)
3. The zip file is ready for distribution and contains the complete app bundle

## Installation

### From Pre-built Release
1. Download the latest `MediaTool_YYYYMMDD_HHMMSS.zip` from releases
2. Extract the zip file
3. Drag `MediaTool.app` to your Applications folder
4. Double-click to run (you may need to allow it in System Preferences > Security & Privacy)

### From Source
1. Install Python 3.12+ and required dependencies: `pip install -r requirements.txt`
2. Build the app: `python setup.py bdist_mac`
3. Find the app in `build/MediaTool.app` and the distribution zip in `build/`

### Dependencies
- PyExifTool
- timezonefinder
- tzdata
- cx_Freeze (for building)
- paramiko (for SSH connections in remote mode)